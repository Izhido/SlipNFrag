#include "Keyboard.h"
#include "AppState.h"
#include "CylinderProjection.h"

extern byte* draw_chars;

std::vector<std::vector<KeyboardCell>> Keyboard::cells
{
	{
		{ 40, 0, 16, 16, 4, 4, "`"},
		{ 56, 0, 16, 16, 4, 4, "1"},
		{ 72, 0, 16, 16, 4, 4, "2"},
		{ 88, 0, 16, 16, 4, 4, "3"},
		{ 104, 0, 16, 16, 4, 4, "4"},
		{ 120, 0, 16, 16, 4, 4, "5"},
		{ 136, 0, 16, 16, 4, 4, "6"},
		{ 152, 0, 16, 16, 4, 4, "7"},
		{ 168, 0, 16, 16, 4, 4, "8"},
		{ 184, 0, 16, 16, 4, 4, "9"},
		{ 200, 0, 16, 16, 4, 4, "0"},
		{ 216, 0, 16, 16, 4, 4, "-"},
		{ 232, 0, 16, 16, 4, 4, "="},
		{ 248, 0, 32, 16, 0, 4, "Bksp"},
		{ 40, 16, 24, 16, 0, 4, "Tab"},
		{ 64, 16, 16, 16, 4, 4, "q"},
		{ 80, 16, 16, 16, 4, 4, "w"},
		{ 96, 16, 16, 16, 4, 4, "e"},
		{ 112, 16, 16, 16, 4, 4, "r"},
		{ 128, 16, 16, 16, 4, 4, "t"},
		{ 144, 16, 16, 16, 4, 4, "y"},
		{ 160, 16, 16, 16, 4, 4, "u"},
		{ 176, 16, 16, 16, 4, 4, "i"},
		{ 192, 16, 16, 16, 4, 4, "o"},
		{ 208, 16, 16, 16, 4, 4, "p"},
		{ 224, 16, 16, 16, 4, 4, "["},
		{ 240, 16, 16, 16, 4, 4, "]"},
		{ 256, 16, 24, 16, 4, 4, "\\"},
		{ 40, 32, 32, 16, 0, 4, "Caps"},
		{ 72, 32, 16, 16, 4, 4, "a"},
		{ 88, 32, 16, 16, 4, 4, "s"},
		{ 104, 32, 16, 16, 4, 4, "d"},
		{ 120, 32, 16, 16, 4, 4, "f"},
		{ 136, 32, 16, 16, 4, 4, "g"},
		{ 152, 32, 16, 16, 4, 4, "h"},
		{ 168, 32, 16, 16, 4, 4, "j"},
		{ 184, 32, 16, 16, 4, 4, "k"},
		{ 200, 32, 16, 16, 4, 4, "l"},
		{ 216, 32, 16, 16, 4, 4, ";"},
		{ 232, 32, 16, 16, 4, 4, "'"},
		{ 248, 32, 32, 16, 0, 4, "Entr"},
		{ 40, 48, 40, 16, 0, 4, "Shift"},
		{ 80, 48, 16, 16, 4, 4, "z"},
		{ 96, 48, 16, 16, 4, 4, "x"},
		{ 112, 48, 16, 16, 4, 4, "c"},
		{ 128, 48, 16, 16, 4, 4, "v"},
		{ 144, 48, 16, 16, 4, 4, "b"},
		{ 160, 48, 16, 16, 4, 4, "n"},
		{ 176, 48, 16, 16, 4, 4, "m"},
		{ 192, 48, 16, 16, 4, 4, ","},
		{ 208, 48, 16, 16, 4, 4, "."},
		{ 224, 48, 16, 16, 4, 4, "/"},
		{ 240, 48, 40, 16, 0, 4, "Shift"},
		{ 40, 64, 32, 16, 0, 4, "Ctrl"},
		{ 72, 64, 32, 16, 4, 4, "Alt"},
		{ 104, 64, 112, 16, 36, 6, "Space"},
		{ 216, 64, 32, 16, 4, 4, "Alt"},
		{ 248, 64, 32, 16, 0, 4, "Ctrl"}
	},
	{
		{ 40, 0, 16, 16, 4, 4, "`"},
		{ 56, 0, 16, 16, 4, 4, "1"},
		{ 72, 0, 16, 16, 4, 4, "2"},
		{ 88, 0, 16, 16, 4, 4, "3"},
		{ 104, 0, 16, 16, 4, 4, "4"},
		{ 120, 0, 16, 16, 4, 4, "5"},
		{ 136, 0, 16, 16, 4, 4, "6"},
		{ 152, 0, 16, 16, 4, 4, "7"},
		{ 168, 0, 16, 16, 4, 4, "8"},
		{ 184, 0, 16, 16, 4, 4, "9"},
		{ 200, 0, 16, 16, 4, 4, "0"},
		{ 216, 0, 16, 16, 4, 4, "-"},
		{ 232, 0, 16, 16, 4, 4, "="},
		{ 248, 0, 32, 16, 0, 4, "Bksp"},
		{ 40, 16, 24, 16, 0, 4, "Tab"},
		{ 64, 16, 16, 16, 4, 4, "Q"},
		{ 80, 16, 16, 16, 4, 4, "W"},
		{ 96, 16, 16, 16, 4, 4, "E"},
		{ 112, 16, 16, 16, 4, 4, "R"},
		{ 128, 16, 16, 16, 4, 4, "T"},
		{ 144, 16, 16, 16, 4, 4, "Y"},
		{ 160, 16, 16, 16, 4, 4, "U"},
		{ 176, 16, 16, 16, 4, 4, "I"},
		{ 192, 16, 16, 16, 4, 4, "O"},
		{ 208, 16, 16, 16, 4, 4, "P"},
		{ 224, 16, 16, 16, 4, 4, "["},
		{ 240, 16, 16, 16, 4, 4, "]"},
		{ 256, 16, 24, 16, 4, 4, "\\"},
		{ 40, 32, 32, 16, 0, 4, "CAPS"},
		{ 72, 32, 16, 16, 4, 4, "A"},
		{ 88, 32, 16, 16, 4, 4, "S"},
		{ 104, 32, 16, 16, 4, 4, "D"},
		{ 120, 32, 16, 16, 4, 4, "F"},
		{ 136, 32, 16, 16, 4, 4, "G"},
		{ 152, 32, 16, 16, 4, 4, "H"},
		{ 168, 32, 16, 16, 4, 4, "J"},
		{ 184, 32, 16, 16, 4, 4, "K"},
		{ 200, 32, 16, 16, 4, 4, "L"},
		{ 216, 32, 16, 16, 4, 4, ";"},
		{ 232, 32, 16, 16, 4, 4, "'"},
		{ 248, 32, 32, 16, 0, 4, "Entr"},
		{ 40, 48, 40, 16, 0, 4, "Shift"},
		{ 80, 48, 16, 16, 4, 4, "Z"},
		{ 96, 48, 16, 16, 4, 4, "X"},
		{ 112, 48, 16, 16, 4, 4, "C"},
		{ 128, 48, 16, 16, 4, 4, "V"},
		{ 144, 48, 16, 16, 4, 4, "B"},
		{ 160, 48, 16, 16, 4, 4, "N"},
		{ 176, 48, 16, 16, 4, 4, "M"},
		{ 192, 48, 16, 16, 4, 4, ","},
		{ 208, 48, 16, 16, 4, 4, "."},
		{ 224, 48, 16, 16, 4, 4, "/"},
		{ 240, 48, 40, 16, 0, 4, "Shift"},
		{ 40, 64, 32, 16, 0, 4, "Ctrl"},
		{ 72, 64, 32, 16, 4, 4, "Alt"},
		{ 104, 64, 112, 16, 36, 6, "Space"},
		{ 216, 64, 32, 16, 4, 4, "Alt"},
		{ 248, 64, 32, 16, 0, 4, "Ctrl"}
	},
	{
		{ 40, 0, 16, 16, 4, 4, "~"},
		{ 56, 0, 16, 16, 4, 4, "!"},
		{ 72, 0, 16, 16, 4, 4, "@"},
		{ 88, 0, 16, 16, 4, 4, "#"},
		{ 104, 0, 16, 16, 4, 4, "$"},
		{ 120, 0, 16, 16, 4, 4, "%"},
		{ 136, 0, 16, 16, 4, 4, "^"},
		{ 152, 0, 16, 16, 4, 4, "&"},
		{ 168, 0, 16, 16, 4, 4, "*"},
		{ 184, 0, 16, 16, 4, 4, "("},
		{ 200, 0, 16, 16, 4, 4, ")"},
		{ 216, 0, 16, 16, 4, 4, "_"},
		{ 232, 0, 16, 16, 4, 4, "+"},
		{ 248, 0, 32, 16, 0, 4, "Bksp"},
		{ 40, 16, 24, 16, 0, 4, "Tab"},
		{ 64, 16, 16, 16, 4, 4, "Q"},
		{ 80, 16, 16, 16, 4, 4, "W"},
		{ 96, 16, 16, 16, 4, 4, "E"},
		{ 112, 16, 16, 16, 4, 4, "R"},
		{ 128, 16, 16, 16, 4, 4, "T"},
		{ 144, 16, 16, 16, 4, 4, "Y"},
		{ 160, 16, 16, 16, 4, 4, "U"},
		{ 176, 16, 16, 16, 4, 4, "I"},
		{ 192, 16, 16, 16, 4, 4, "O"},
		{ 208, 16, 16, 16, 4, 4, "P"},
		{ 224, 16, 16, 16, 4, 4, "{"},
		{ 240, 16, 16, 16, 4, 4, "}"},
		{ 256, 16, 24, 16, 4, 4, "|"},
		{ 40, 32, 32, 16, 0, 4, "Caps"},
		{ 72, 32, 16, 16, 4, 4, "A"},
		{ 88, 32, 16, 16, 4, 4, "S"},
		{ 104, 32, 16, 16, 4, 4, "D"},
		{ 120, 32, 16, 16, 4, 4, "F"},
		{ 136, 32, 16, 16, 4, 4, "G"},
		{ 152, 32, 16, 16, 4, 4, "H"},
		{ 168, 32, 16, 16, 4, 4, "J"},
		{ 184, 32, 16, 16, 4, 4, "K"},
		{ 200, 32, 16, 16, 4, 4, "L"},
		{ 216, 32, 16, 16, 4, 4, ":"},
		{ 232, 32, 16, 16, 4, 4, "\""},
		{ 248, 32, 32, 16, 0, 4, "Entr"},
		{ 40, 48, 40, 16, 0, 4, "SHIFT"},
		{ 80, 48, 16, 16, 4, 4, "Z"},
		{ 96, 48, 16, 16, 4, 4, "X"},
		{ 112, 48, 16, 16, 4, 4, "C"},
		{ 128, 48, 16, 16, 4, 4, "V"},
		{ 144, 48, 16, 16, 4, 4, "B"},
		{ 160, 48, 16, 16, 4, 4, "N"},
		{ 176, 48, 16, 16, 4, 4, "M"},
		{ 192, 48, 16, 16, 4, 4, "<"},
		{ 208, 48, 16, 16, 4, 4, ">"},
		{ 224, 48, 16, 16, 4, 4, "?"},
		{ 240, 48, 40, 16, 0, 4, "SHIFT"},
		{ 40, 64, 32, 16, 0, 4, "Ctrl"},
		{ 72, 64, 32, 16, 4, 4, "Alt"},
		{ 104, 64, 112, 16, 36, 6, "Space"},
		{ 216, 64, 32, 16, 4, 4, "Alt"},
		{ 248, 64, 32, 16, 0, 4, "Ctrl"}
	},
	{
		{ 40, 0, 16, 16, 4, 4, "~"},
		{ 56, 0, 16, 16, 4, 4, "!"},
		{ 72, 0, 16, 16, 4, 4, "@"},
		{ 88, 0, 16, 16, 4, 4, "#"},
		{ 104, 0, 16, 16, 4, 4, "$"},
		{ 120, 0, 16, 16, 4, 4, "%"},
		{ 136, 0, 16, 16, 4, 4, "^"},
		{ 152, 0, 16, 16, 4, 4, "&"},
		{ 168, 0, 16, 16, 4, 4, "*"},
		{ 184, 0, 16, 16, 4, 4, "("},
		{ 200, 0, 16, 16, 4, 4, ")"},
		{ 216, 0, 16, 16, 4, 4, "_"},
		{ 232, 0, 16, 16, 4, 4, "+"},
		{ 248, 0, 32, 16, 0, 4, "Bksp"},
		{ 40, 16, 24, 16, 0, 4, "Tab"},
		{ 64, 16, 16, 16, 4, 4, "q"},
		{ 80, 16, 16, 16, 4, 4, "w"},
		{ 96, 16, 16, 16, 4, 4, "e"},
		{ 112, 16, 16, 16, 4, 4, "r"},
		{ 128, 16, 16, 16, 4, 4, "t"},
		{ 144, 16, 16, 16, 4, 4, "y"},
		{ 160, 16, 16, 16, 4, 4, "u"},
		{ 176, 16, 16, 16, 4, 4, "i"},
		{ 192, 16, 16, 16, 4, 4, "o"},
		{ 208, 16, 16, 16, 4, 4, "p"},
		{ 224, 16, 16, 16, 4, 4, "{"},
		{ 240, 16, 16, 16, 4, 4, "}"},
		{ 256, 16, 24, 16, 4, 4, "|"},
		{ 40, 32, 32, 16, 0, 4, "CAPS"},
		{ 72, 32, 16, 16, 4, 4, "a"},
		{ 88, 32, 16, 16, 4, 4, "s"},
		{ 104, 32, 16, 16, 4, 4, "d"},
		{ 120, 32, 16, 16, 4, 4, "f"},
		{ 136, 32, 16, 16, 4, 4, "g"},
		{ 152, 32, 16, 16, 4, 4, "h"},
		{ 168, 32, 16, 16, 4, 4, "j"},
		{ 184, 32, 16, 16, 4, 4, "k"},
		{ 200, 32, 16, 16, 4, 4, "l"},
		{ 216, 32, 16, 16, 4, 4, ":"},
		{ 232, 32, 16, 16, 4, 4, "\""},
		{ 248, 32, 32, 16, 0, 4, "Entr"},
		{ 40, 48, 40, 16, 0, 4, "SHIFT"},
		{ 80, 48, 16, 16, 4, 4, "z"},
		{ 96, 48, 16, 16, 4, 4, "x"},
		{ 112, 48, 16, 16, 4, 4, "c"},
		{ 128, 48, 16, 16, 4, 4, "v"},
		{ 144, 48, 16, 16, 4, 4, "b"},
		{ 160, 48, 16, 16, 4, 4, "n"},
		{ 176, 48, 16, 16, 4, 4, "m"},
		{ 192, 48, 16, 16, 4, 4, "<"},
		{ 208, 48, 16, 16, 4, 4, ">"},
		{ 224, 48, 16, 16, 4, 4, "?"},
		{ 240, 48, 40, 16, 0, 4, "SHIFT"},
		{ 40, 64, 32, 16, 0, 4, "Ctrl"},
		{ 72, 64, 32, 16, 4, 4, "Alt"},
		{ 104, 64, 112, 16, 36, 6, "Space"},
		{ 216, 64, 32, 16, 4, 4, "Alt"},
		{ 248, 64, 32, 16, 0, 4, "Ctrl"}
	},
};

void Keyboard::Create(AppState& appState)
{
	buffer.resize(appState.ConsoleWidth * appState.ConsoleHeight / 2);
}

bool Keyboard::Handle(AppState& appState)
{
	if (draw_chars == nullptr || key_dest != key_console)
	{
		return false;
	}
	leftHighlighted = -1;
	if (appState.LeftController.TrackingResult == ovrSuccess)
	{
		float x;
		float y;
		if (CylinderProjection::HitPoint(appState, appState.LeftController, x, y))
		{
			auto horizontal = (int)(x * appState.ConsoleWidth);
			auto vertical = (int)(y * appState.ConsoleHeight) - appState.ConsoleHeight / 2;
			auto& source = cells[(int)layout];
			for (auto i = 0; i < source.size(); i++)
			{
				auto& cell = source[i];
				if (horizontal >= cell.left && horizontal < cell.left + cell.width && vertical >= cell.top && vertical < cell.top + cell.height)
				{
					leftHighlighted = i;
					break;
				}
			}
		}
	}
	rightHighlighted = -1;
	if (appState.RightController.TrackingResult == ovrSuccess)
	{
		float x;
		float y;
		if (CylinderProjection::HitPoint(appState, appState.RightController, x, y))
		{
			auto horizontal = (int)(x * appState.ConsoleWidth);
			auto vertical = (int)(y * appState.ConsoleHeight) - appState.ConsoleHeight / 2;
			auto& source = cells[(int)layout];
			for (auto i = 0; i < source.size(); i++)
			{
				auto& cell = source[i];
				if (horizontal >= cell.left && horizontal < cell.left + cell.width && vertical >= cell.top && vertical < cell.top + cell.height)
				{
					rightHighlighted = i;
					break;
				}
			}
		}
	}
	return false;
}

void Keyboard::Fill(AppState& appState, KeyboardCell& cell, unsigned char color)
{
	auto target = buffer.data() + cell.top * appState.ConsoleWidth + cell.left;
	for (auto j = cell.height; j > 0; j--)
	{
		for (auto i = cell.width; i > 0; i--)
		{
			*target++ = color;
		}
		target += appState.ConsoleWidth - cell.width;
	}
}

void Keyboard::Print(AppState& appState, KeyboardCell& cell, bool upper)
{
	auto start = buffer.data() + (cell.top + cell.offsetY) * appState.ConsoleWidth + cell.left + cell.offsetX;
	for (auto k = 0; cell.text[k] != 0; k++)
	{
		auto num = cell.text[k];
		if (upper)
		{
			num += 128;
		}
		auto row = num>>4;
		auto col = num&15;
		auto source = draw_chars + (row<<10) + (col<<3);
		auto target = start;
		for (auto j = 8; j > 0; j--)
		{
			for (auto i = 8; i > 0; i--)
			{
				auto c = *source++;
				if (c > 0)
				{
					*target = c;
				}
				target++;
			}
			target += appState.ConsoleWidth - 8;
			source += 128 - 8;
		}
		start += 8;
	}
}

bool Keyboard::Draw(AppState& appState)
{
	if (draw_chars == nullptr || key_dest != key_console)
	{
		return false;
	}
	std::fill(buffer.begin(), buffer.end(), 255);
	auto& source = cells[(int)layout];
	for (auto i = 0; i < source.size(); i++)
	{
		auto& cell = source[i];
		if (i == leftHighlighted)
		{
			Fill(appState, cell, 3);
		}
		if (i == rightHighlighted)
		{
			Fill(appState, cell, 3);
		}
		if (i == leftPressed)
		{
			Fill(appState, cell, 15);
			Print(appState, cell, true);
		}
		else if (i == rightPressed)
		{
			Fill(appState, cell, 15);
			Print(appState, cell, true);
		}
		else
		{
			Print(appState, cell, false);
		}
	}
	return true;
}
